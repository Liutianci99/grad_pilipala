# 功能规范：路由守卫 + 角色权限控制

**分支**: `feat/route-guards`
**创建日期**: 2026-02-20
**状态**: 审核中

## 用户场景

### 用户故事 1 — 未登录用户被拦截（优先级：P1）

未登录的用户尝试直接访问系统内部页面（如通过浏览器地址栏输入 URL），系统应自动跳转到登录页。

**为什么这个优先级**: 这是最基本的安全需求，没有登录就不应该看到任何数据。

**验收场景**:
1. **当** 用户未登录，**访问** `/admin/user-management`，**则** 自动跳转到登录页 `/`
2. **当** 用户未登录，**访问** `/consumer/my-orders`，**则** 自动跳转到登录页 `/`
3. **当** 用户未登录，**访问** `/driver/pending-pickup`，**则** 自动跳转到登录页 `/`

---

### 用户故事 2 — 角色越权被拦截（优先级：P1）

已登录的用户尝试访问不属于自己角色的页面，系统应跳转到首页（不是登录页）。

**为什么这个优先级**: 防止顾客看到管理员页面、商户看到配送员页面等越权行为。

**验收场景**:
1. **当** 顾客已登录，**访问** `/admin/user-management`，**则** 跳转到 `/demo`（首页）
2. **当** 商户已登录，**访问** `/consumer/my-orders`，**则** 跳转到 `/demo`
3. **当** 配送员已登录，**访问** `/admin/data-analysis`，**则** 跳转到 `/demo`
4. **当** 管理员已登录，**访问** `/admin/data-analysis`，**则** 正常进入

---

### 用户故事 3 — Token 过期自动登出（优先级：P2）

用户在使用过程中 JWT token 过期，后端返回 401，前端应自动清除登录状态并跳转到登录页，显示友好提示。

**为什么这个优先级**: 比越权拦截优先级低，但对用户体验很重要。

**验收场景**:
1. **当** 用户正在操作，**后端返回** 401，**则** 清除 sessionStorage + 跳转登录页 + 显示"登录已过期，请重新登录"
2. **当** 用户已登录，**访问** 登录页 `/`，**则** 自动跳转到 `/demo`

---

### 边界情况
- sessionStorage 被手动清除后刷新页面 → 应跳转到登录页
- 用户角色字段为空或无效 → 应跳转到登录页
- 多个标签页同时打开，一个登出后另一个操作 → 401 拦截处理

## 需求

### 功能需求
- **FR-001**: 所有 `/demo` 子路由必须携带 `meta.roles` 元信息
- **FR-002**: `beforeEach` 守卫必须同时检查 token 存在性和角色匹配
- **FR-003**: Axios 响应拦截器必须处理 401 状态码
- **FR-004**: 角色列表必须和 `demo.vue` 中 `menuItems` 的 `roles` 数组保持一致

## 涉及文件

| 文件 | 改动 |
|------|------|
| `frontend/src/router/index.js` | 修改：子路由加 `meta.roles`，增强 `beforeEach` |
| `frontend/src/utils/request.js` | 修改：加 401 拦截器 |

## 验收标准
- [ ] 未登录用户访问任何内部路由 → 跳转登录页
- [ ] 顾客访问 `/admin/*` → 跳转首页（不是登录页）
- [ ] 管理员访问 `/admin/*` → 正常进入
- [ ] 后端返回 401 → 自动登出 + 跳转登录页 + ElMessage 提示
- [ ] 已登录用户访问登录页 → 跳转首页
- [ ] 刷新页面后守卫仍然生效
- [ ] 所有子路由的 `meta.roles` 和侧边栏菜单的 `roles` 一致

## 审核清单
- [x] 没有 `[待确认]` 标记残留
- [x] 需求可测试、无歧义
- [x] 符合项目宪法
- [x] 验收标准完整
