# 功能需求文档

本文档按角色划分，描述系统中每个页面的功能。

---

## 核心业务流程

### 完整物流链路

```
商家入库 → 商城上架 → 顾客下单 → 商家发货 → 快递员揽收 → 创建批次 → 开始运输 → 到达目的地 → 顾客确认收货
```

### 订单状态机

```
未发货(0) → 已发货(1) → 已揽收(2) → 运输中(3) → 已到达(4) → 已收货(5)
   ↑            ↑            ↑            ↑            ↑           ↑
 顾客下单    商家发货     快递员揽收    批次开始运输   批次到达    顾客确认
```

| 状态 | 值 | 触发角色 | 触发动作 |
|------|---|---------|---------|
| 未发货 | 0 | 消费者 | 在商城下单，选择商品+数量+收货地址 |
| 已发货 | 1 | 商户 | 在订单管理页确认发货 |
| 已揽收 | 2 | 配送员 | 在待揽收页执行揽收操作 |
| 运输中 | 3 | 配送员 | 创建配送批次并点击"开始运输" |
| 已到达 | 4 | 配送员 | 批次到达目的地，系统自动更新 |
| 已收货 | 5 | 消费者 | 在我的订单页确认收货 |

### 配送批次状态机

```
待出发(0) → 配送中(1) → 已完成(2)
```

| 状态 | 值 | 触发动作 |
|------|---|---------|
| 待出发 | 0 | 配送员选择多个已揽收订单，创建批次 |
| 配送中 | 1 | 配送员点击"开始运输"，系统规划路线 |
| 已完成 | 2 | 所有订单送达，配送员确认完成 |

### 各角色业务流程

#### 商户流程
1. 入库：在库存管理页录入商品信息（名称、描述、数量、图片、仓库）→ 写入 `inventory` 表
2. 上架：选择已入库商品，设置售价和上架数量 → 写入 `mall` 表，`inventory.is_published = 1`
3. 下架：从商城下架商品 → `mall.is_published = 0`
4. 发货：收到新订单(status=0)后，在订单管理页确认发货 → `orders.status = 1`，记录 `ship_time`

#### 消费者流程
1. 浏览商城：查看所有 `mall.is_published = 1` 的商品
2. 下单：选择商品+数量+收货地址 → 创建 `orders` 记录(status=0)，扣减 `mall.available_quantity`
3. 查看物流：在物流查询页查看订单的实时运输状态（地图+路线+时间线）
4. 确认收货：订单到达(status=4)后，点击确认收货 → `orders.status = 5`，记录 `receive_time`

#### 配送员流程
1. 揽收：查看所属仓库的已发货订单(status=1)，执行揽收 → `orders.status = 2`，记录 `pickup_time`
2. 创建批次：选择多个已揽收订单(status=2)，组成一个配送批次 → 创建 `delivery_batches`(status=0) + `delivery_batch_orders`
3. 开始运输：点击"开始运输" → `delivery_batches.status = 1`，系统调用地图API规划路线 → 创建 `delivery_route`，批次内所有订单 `status = 3`
4. 配送中：系统记录实时GPS位置到 `delivery_location`，前端地图展示货车移动轨迹
5. 送达：到达目的地后，订单 `status = 4`，记录 `delivery_time`
6. 完成批次：所有订单送达后，确认完成 → `delivery_batches.status = 2`

#### 管理员流程
1. 用户管理：CRUD所有用户，按角色筛选
2. 订单管理：查看/搜索/筛选所有订单，可修改订单状态
3. 数据分析：查看用户统计、订单统计、营收数据、趋势图表

### 数据表关系

```
users ──┬── inventory (user_id = 商户)
        ├── mall (merchant_id = 商户)
        ├── orders (customer_id = 消费者, merchant_id = 商户)
        ├── delivery_personnel (user_id = 配送员) ── warehouse
        └── address (user_id = 消费者)

delivery_batches (driver_id = 配送员)
    ├── delivery_batch_orders ── orders
    └── delivery_route
            └── delivery_location (GPS轨迹)
```

---

## 一、管理员（admin）

### 1. 用户管理 `/admin/user-management`
- 查看所有用户列表
- 按角色筛选（管理员/商户/消费者/配送员）
- 搜索用户（用户名/姓名）
- 创建新用户（用户名、密码、姓名、角色、手机号）
- 编辑用户信息
- 删除用户

### 2. 订单管理 `/admin/order-management`
- 查看所有订单列表
- 按状态筛选（待确认/已确认/已发货/运输中/已到达/已完成）
- 搜索订单（订单号/商品名）
- 修改订单状态（下拉选择）
- 删除订单

### 3. 数据分析 `/admin/data-analysis`
- 数据概览卡片（用户总数、订单总数、总营收、活跃商户数）
- 用户角色分布（各角色人数）
- 订单状态分布（各状态数量）
- 近7天订单趋势（柱状图）

---

## 二、商户（merchant）

### 1. 商城 `/general/mall`
- 浏览所有商品列表（卡片展示：图片、名称、价格、库存）
- 搜索商品
- 商户可以下架自己的商品（跳转下架页面）

### 2. 库存管理 `/merchant/inventory-management`
- 查看自己的商品库存列表
- 搜索商品
- 上架新商品（跳转上架页面：商品名、价格、库存、描述、仓库选择）
- 入库操作（跳转入库页面：选择商品、输入数量、选择仓库）
- 编辑商品信息
- 删除商品

### 3. 商品上架 `/merchant/product-listing`
- 填写商品信息（名称、价格、库存数量、描述）
- 选择仓库
- 提交上架

### 4. 商品下架 `/merchant/product-delisting`
- 确认下架商品
- 显示商品信息
- 提交下架

### 5. 商品入库 `/merchant/stock-in`
- 选择已有商品
- 输入入库数量
- 选择目标仓库
- 提交入库

### 6. 订单管理 `/merchant/order-management`
- 查看自己的订单列表
- 按状态筛选
- 搜索订单
- 确认订单（待确认 → 已确认）
- 发货操作（已确认 → 已发货）

### 7. 物流查询 `/merchant/logistics-query`
- 查看自己订单的物流信息列表
- 搜索订单
- 按状态筛选
- 点击查看物流详情（地图 + 路线 + 时间线 + 实时追踪）

---

## 三、消费者（consumer）

### 1. 商城 `/general/mall`
- 浏览所有商品列表
- 搜索商品
- 购买商品（选择数量、选择收货地址、提交订单）

### 2. 我的订单 `/consumer/my-orders`
- 查看自己的订单列表
- 按状态筛选
- 搜索订单
- 查看订单详情（商品、数量、金额、状态）

### 3. 地址管理 `/consumer/address-management`
- 查看收货地址列表
- 添加新地址（收货人、手机号、省市区、详细地址）
- 编辑地址
- 删除地址
- 设置默认地址

### 4. 物流查询 `/consumer/logistics-query`
- 查看自己订单的物流信息列表
- 搜索订单
- 按状态筛选
- 点击查看物流详情

#### 消费者物流地图规则
- 消费者只能看到**从配送员仓库地址（起点）到自己收货地址（终点）**的路线，看不到同批次中其他顾客的地址
- **运输中(status=3)**：地图显示路线(route) + 配送员实时移动的 marker
- **已到达(status=4) / 已收货(status=5)**：地图显示从仓库到自己地址的完整路线，配送员 marker 停在自己的地址上，表示已送达

---

## 四、配送员（driver）

### 1. 待揽收 `/driver/pending-pickup`
- 查看待揽收的包裹列表
- 搜索包裹
- 执行揽收操作（标记为已揽收）

### 2. 待送货 `/driver/pending-delivery`
- 查看待配送的订单列表
- 搜索订单
- 创建配送批次（选择多个订单 → 组成一个批次）

### 3. 运输批次 `/driver/delivery-batch`
- 查看自己的配送批次列表
- 按状态筛选（进行中/已完成）
- 点击查看批次详情
- **一次只能运输一个批次**：当某个批次状态为"配送中"(status=1)时，其他待出发批次的"开始运输"按钮变灰不可点击

### 4. 批次详情 `/driver/delivery-batch-detail`
- 查看批次内的所有订单
- 完成配送操作（标记批次为已完成）

### 运输批次核心逻辑

#### 路线规划
- 点击"开始运输"后，以配送员所属仓库地址为**起点**，距离最远的订单顾客地址为**终点**，其余订单顾客地址为**途径点**
- 调用腾讯地图路径规划API，获取一条完整的驾车路线
- 在地图上绘制该路线（polyline）

#### 配送模拟
- 配送员以**恒定速度**从起点沿路线运动
- 配送员的实时位置随时间变化，通过地图上的 marker 体现
- 每个订单的顾客地址也以 marker 形式显示在地图上，配送员可以看到本批次所有订单的地址
- 当配送员到达某个订单的顾客地址时，该订单状态自动更新（运输中→已到达）

#### 约束
- 一个配送员同一时间只能有一个"配送中"的批次

### 5. 历史任务 `/driver/history-tasks`
- 查看已完成的配送批次列表
- 搜索历史批次
- 查看历史批次详情

---

## 通用页面

### 登录页 `/`
- 输入用户名、密码
- 选择角色（管理员/商户/消费者/配送员）
- 登录后跳转到对应角色的首页
- 底部两个按钮并排：登录 + 注册（跳转注册页）

### 注册页 `/register`
- 输入用户名、密码、确认密码
- 选择角色（商户/消费者/配送员，不允许注册管理员）
- 注册成功后自动登录并跳转到对应角色首页
- 底部链接跳转回登录页

### 主框架 `/demo`
- 深色侧边栏（根据角色显示不同菜单）
- 白色内容区
- 面包屑导航
- 用户信息卡片 + 登出按钮
